<!--
  base.html

  Esta es la plantilla principal de la aplicación. Define la estructura general de la página,
  incluyendo la barra de navegación superior, la barra lateral y el área de contenido.
  Otras plantillas (como panel.html) heredan de esta.
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Meta tag para asegurar que la página sea responsive en dispositivos móviles -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- El título de la página puede ser personalizado por las plantillas hijas -->
    <title>{% block title %}HEM Lending - Panel{% endblock %}</title>
    
    <!-- Carga los archivos estáticos de Django -->
    {% load static %}
    
    <!-- Enlace a la hoja de estilos principal -->
    <link rel="stylesheet" href="{% static 'style/base.css' %}">
    
    <!-- Enlace a Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <link rel="icon" href="{% static 'img/favicon.png' %}" type="image/svg+xml">

    <!--
      ============================================
      INCORPORACIÓN DE BOOTSTRAP 5 (CSS)
      ============================================
      Se añade el CSS de Bootstrap desde un CDN (Content Delivery Network).
      Esto proporciona todos los estilos del framework para los componentes,
      el sistema de rejilla y las utilidades, sin necesidad de alojar los archivos localmente.
      Se coloca en el <head> para que los estilos se carguen antes de que se renderice el cuerpo de la página.
    -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Estilos para django-select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    {{ form.media.css }}
</head>
<body>

    <!-- =================================== -->
    <!-- BARRA DE NAVEGACIÓN SUPERIOR (FIJA) -->
    <!-- =================================== -->
    <header class="top-navbar">
        <!-- Botón Hamburguesa para pantallas pequeñas (visible solo en móvil/tablet) -->
        <button class="btn btn-dark d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
            <i class="fa-solid fa-bars"></i>
        </button>

        <!-- Logo de la empresa a la izquierda -->
        <div class="logo">HEM Lending</div>
        
        <!-- Navegación de usuario a la derecha (usando Dropdown de Bootstrap) -->
        <nav class="user-nav ms-auto">
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa-solid fa-user-circle"></i> {{ user.username }}
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="fa-solid fa-user"></i> Ver Perfil</a></li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form action="{% url 'logout' %}" method="post" class="d-flex">
                      {% csrf_token %}
                      <button type="submit" class="dropdown-item">
                          <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
                      </button>
                  </form>
                </li>
              </ul>
            </div>
        </nav>
    </header>

    <!-- ====================================================== -->
    <!-- BARRA LATERAL RESPONSIVA (Offcanvas de Bootstrap)    -->
    <!-- ====================================================== -->
    <aside class="offcanvas-lg offcanvas-start" tabindex="-1" id="sidebarMenu">
        <!-- Cabecera del menú Offcanvas (visible solo en móvil/tablet) -->
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menú</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#sidebarMenu" aria-label="Close"></button>
        </div>

        <!-- Cuerpo del menú Offcanvas con la navegación -->
        <div class="offcanvas-body">
            <nav class="vertical-navbar">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'panel_informativo' %}"><i class="fa-solid fa-chart-pie fa-fw me-2"></i>Panel Informativo</a>
                    </li>

                    <li class="nav-title"><i class="fa-solid fa-folder-open fa-fw me-2"></i>GESTIÓN</li>

                    <li class="nav-item nav-section-gestion dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa-solid fa-users fa-fw me-2"></i>Clientes
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'client_list' %}">Ver Lista de Clientes</a></li>
                            <li><a class="dropdown-item" href="{% url 'client_add' %}">Registrar Nuevo Cliente</a></li>
                        </ul>
                    </li>

                    <li class="nav-item nav-section-gestion dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa-solid fa-hand-holding-dollar fa-fw me-2"></i>Préstamos
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'loan_list' %}">Ver Préstamos Activos</a></li>
                            <li><a class="dropdown-item" href="{% url 'loan_add' %}">Registrar Nuevo Préstamo</a></li>
                            <li><a class="dropdown-item" href="{% url 'paid_loan_list' %}">Ver Préstamos Pagados</a></li>
                        </ul>
                    </li>

                    <li class="nav-title"><i class="fa-solid fa-sack-dollar fa-fw me-2"></i>FINANZAS</li>

                    <li class="nav-item nav-section-finanzas">
                        <a class="nav-link" href="{% url 'cobros_list' %}"><i class="fa-solid fa-file-invoice-dollar fa-fw me-2"></i>Cuotas Vencidas</a>
                    </li>

                    <li class="nav-item nav-section-finanzas">
                        <a class="nav-link" href="{% url 'financial_details' %}"><i class="fa-solid fa-money-bill-trend-up fa-fw me-2"></i>Resumen Financiero</a>
                    </li>

                    <li class="nav-title"><i class="fa-solid fa-gears fa-fw me-2"></i>CONFIGURACIÓN</li>

                    <li class="nav-item nav-section-config">
                        <a class="nav-link" href="{% url 'admin:gestion_prestamos_tipoprestamo_changelist' %}"><i class="fa-solid fa-tags fa-fw me-2"></i>Tipos de Préstamo</a>
                    </li>
                    <li class="nav-item nav-section-config">
                        <a class="nav-link" href="{% url 'admin:gestion_prestamos_tipogasto_changelist' %}"><i class="fa-solid fa-money-check-dollar fa-fw me-2"></i>Tipos de Gasto</a>
                    </li>
                    <li class="nav-item nav-section-config">
                        <a class="nav-link" href="{% url 'admin:gestion_prestamos_capital_changelist' %}"><i class="fa-solid fa-landmark fa-fw me-2"></i>Capital Inicial</a>
                    </li>
                    <li class="nav-item nav-section-config">
                        <a class="nav-link" href="{% url 'admin:auth_group_changelist' %}"><i class="fa-solid fa-users-gear fa-fw me-2"></i>Grupos de Usuarios</a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- ================================= -->
    <!-- ÁREA DE CONTENIDO PRINCIPAL       -->
    <!-- ================================= -->
    <main class="main-content">
        {% block content %}
        {% endblock %}
    </main>

    <!-- El script de jQuery y el script personalizado para los menús ya no son necesarios -->
    {{ form.media.js }}
    <script>
        // Espera a que todo el contenido del DOM esté cargado antes de ejecutar el script
        document.addEventListener('DOMContentLoaded', function() {
            
            /**
             * Función genérica para manejar la apertura y cierre de los menús 
             * (tanto el de usuario como el de la barra lateral).
             */
            const toggleHandler = function(event) {
                // Previene que el navegador siga el enlace (ej. href="#")
                event.preventDefault();

                // Encuentra el menú desplegable que es hermano del elemento clickeado
                const menu = this.nextElementSibling;
                if (!menu) return; // Si no hay menú, no hace nada
                
                // Guarda si el menú actual ya estaba activo antes del clic
                const isAlreadyActive = menu.classList.contains('active');

                // Cierra todos los menús que estén abiertos para evitar tener múltiples menús abiertos
                document.querySelectorAll('.submenu.active, .dropdown-menu.active').forEach(function(m) {
                    m.classList.remove('active');
                });

                // Si el menú no estaba activo, lo abre. Si ya estaba activo, lo deja cerrado (efecto de cierre al volver a hacer clic).
                if (!isAlreadyActive) {
                    menu.classList.add('active');
                }
            };

            // Selecciona todos los elementos que activan menús y les asigna el manejador de eventos
            const toggles = document.querySelectorAll('[data-toggle="submenu"], [data-toggle="dropdown"]');
            toggles.forEach(function(toggle) {
                toggle.addEventListener('click', toggleHandler);
            });

            /**
             * Cierra los menús si el usuario hace clic en cualquier lugar fuera de ellos.
             * Esto mejora la experiencia de usuario.
             */
            window.addEventListener('click', function(event) {
                // Comprueba si el clic no fue dentro de un menú de usuario o un activador de submenú
                if (!event.target.closest('.user-menu') && !event.target.closest('[data-toggle="submenu"]')) {
                    document.querySelectorAll('.submenu.active, .dropdown-menu.active').forEach(function(menu) {
                        menu.classList.remove('active');
                    });
                }
            });
        });
    </script>

    <!--
      ==============================================================
      INCORPORACIÓN DE JQUERY
      ==============================================================
      Se añade jQuery desde un CDN. Es un requisito para django-select2.
      Debe cargarse antes del JavaScript de Bootstrap y de {{ form.media.js }}.
    -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <!--
      ==============================================================
      INCORPORACIÓN DE SELECT2 (JAVASCRIPT)
      ==============================================================
      Se añade el JS de Select2 desde un CDN, después de jQuery.
    -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <script>
        // Inicialización manual de todos los widgets de Select2
        $(document).ready(function() {
            $('.django-select2').select2();
        });
    </script>

    <!--
      ==============================================================
      INCORPORACIÓN DE BOOTSTRAP 5 (JAVASCRIPT BUNDLE)
      ==============================================================
      Se añade el JavaScript de Bootstrap (Bundle) desde un CDN.
      El 'bundle' incluye Popper.js, que es necesario para componentes
      avanzados como tooltips, popovers y menús desplegables.
      Se coloca al final del <body> para no bloquear la renderización del contenido HTML.
    -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Script para auto-ocultar los mensajes de alerta después de 5 segundos
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000); // 5000 milisegundos = 5 segundos
            });
        });
    </script>
</body>
</html>